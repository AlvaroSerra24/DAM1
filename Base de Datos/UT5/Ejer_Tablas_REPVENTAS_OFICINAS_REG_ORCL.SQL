-- ***************TABLA REPVENTAS ***********************

DROP TABLE REPVENTAS CASCADE CONSTRAINTS;
DROP TABLE REGIONES CASCADE CONSTRAINTS;
DROP TABLE OFICINAS CASCADE CONSTRAINTS;

CREATE TABLE OFICINAS 
    ( 
     OFICINA NUMBER (2)  NOT NULL , 
     CIUDAD VARCHAR2 (15 CHAR) , 
     COD_REGION NUMBER (2)  NOT NULL , 
     DIRECTOR NUMBER (3), 
     TOTAL_VENTAS NUMBER (9,2) 
    ) ;



ALTER TABLE OFICINAS 
    ADD CONSTRAINT "OFICINAS_PK" PRIMARY KEY ( OFICINA ) ;



CREATE TABLE REGIONES 
    ( 
     COD_REGION NUMBER (2)  NOT NULL , 
     NOMBRE_RE VARCHAR2 (25 CHAR) 
    ) ;



ALTER TABLE REGIONES 
    ADD CONSTRAINT "REGIONES_PK" PRIMARY KEY ( COD_REGION ) ;



CREATE TABLE REPVENTAS 
    ( 
     NUMERO_REP NUMBER (3)  NOT NULL , 
     NOMBRE VARCHAR2 (15 CHAR)  NOT NULL , 
     EDAD NUMBER (2) , 
     OFICINA_REP NUMBER (2) , 
     DIRECTOR NUMBER (3) , 
     NUM_VENTAS NUMBER (2) , 
     IMP_VENTAS NUMBER (7,2) 
    ) ;



ALTER TABLE REPVENTAS 
    ADD CONSTRAINT "REPVENTAS_PK" PRIMARY KEY ( NUMERO_REP ) ;


INSERT INTO REPVENTAS VALUES (110,'Antonio Casado',41,11,101,2,707);
INSERT INTO REPVENTAS VALUES (106,'José Sánchez',52,11,NULL,15,1612);
INSERT INTO REPVENTAS VALUES (109,'Maria Gutierrez',31,11,106,2,1999);
INSERT INTO REPVENTAS VALUES (103,'Pablo Cruz',29,12,104,5,1286);
INSERT INTO REPVENTAS VALUES (101,'David Ruiz',45,12,104,2,2001);
INSERT INTO REPVENTAS VALUES (104,'Juan Agudo',33,12,106,12,2200);
INSERT INTO REPVENTAS VALUES (105,'Pedro Adams',37,13,104,23,2054);
INSERT INTO REPVENTAS VALUES (108,'Carlos Figo',62,21,106,3,2100);
INSERT INTO REPVENTAS VALUES (102,'Sara Agudo',48,21,108,22,2789);
INSERT INTO REPVENTAS VALUES (107,'Juani Annea',49,22,108,4,1090);

INSERT INTO REPVENTAS VALUES (200,'Anonimo',NULL,NULL,NULL,7,1590);
INSERT INTO REPVENTAS VALUES (201,'Anonima',NULL,NULL,NULL,3,3500);

COMMIT; 



INSERT INTO OFICINAS VALUES (11, 'Alicante',2,106,4900);
INSERT INTO OFICINAS VALUES (12, 'Barcelona',3,	104,	4900);
INSERT INTO OFICINAS VALUES (13,'Valencia',2, 	105, 2303);
INSERT INTO OFICINAS VALUES (21,'Cádiz',1,108,	4988);
INSERT INTO OFICINAS VALUES (22,'Sevilla',1,108, 1780);
INSERT INTO OFICINAS VALUES (23,'Huelva',1,NULL, 1000);
INSERT INTO OFICINAS VALUES (30,'Guadalajara',4,NULL, 1000);

COMMIT;

INSERT INTO REGIONES VALUES (1, 'ANDALUCIA');
INSERT INTO REGIONES VALUES (2, 'LEVANTE');
INSERT INTO REGIONES VALUES (3, 'CATALUÑA');
INSERT INTO REGIONES VALUES (4, 'CENTRO');
INSERT INTO REGIONES VALUES (5, 'EXTREMADURA');
INSERT INTO REGIONES VALUES (6, 'NORTE');

COMMIT;



ALTER TABLE OFICINAS 
    ADD CONSTRAINT DIRECTOROFICINAS FOREIGN KEY 
    ( 
     DIRECTOR
    ) 
    REFERENCES REPVENTAS 
    ( 
     NUMERO_REP
    ) ;


ALTER TABLE REPVENTAS 
    ADD CONSTRAINT DIRECTORREPVENTAS FOREIGN KEY 
    ( 
     DIRECTOR
    ) 
    REFERENCES REPVENTAS 
    ( 
     NUMERO_REP
    ) ;


ALTER TABLE REPVENTAS 
    ADD CONSTRAINT OFICINA FOREIGN KEY 
    ( 
     OFICINA_REP
    ) 
    REFERENCES OFICINAS 
    ( 
     OFICINA
    ) ;


ALTER TABLE OFICINAS 
    ADD CONSTRAINT OFICINASREGIONES FOREIGN KEY 
    ( 
     COD_REGION
    ) 
    REFERENCES REGIONES 
    ( 
     COD_REGION
    ) ;



--  *******FIN CREACION TABLAS *****************


/*EJERCICIO1*/

SELECT NOMBRE
FROM REPVENTAS
WHERE DIRECTOR IN
(SELECT NUMERO_REP FROM REPVENTAS WHERE NOMBRE ='Juan Agudo');

/*EJERCICIO 2*/
SELECT NOMBRE FROM REPVENTAS WHERE
NUMERO_REP IN (SELECT DIRECTOR FROM REPVENTAS WHERE EDAD <40);

/*EJERCICIO 3*/
SELECT NOMBRE_RE FROM REGIONES
WHERE COD_REGION IN
(SELECT COD_REGION
FROM OFICINAS WHERE DIRECTOR IS NULL);

/*EJERCICIO 4*/
SELECT NOMBRE FROM REPVENTAS WHERE OFICINA_REP IN 
(SELECT OFICINA
FROM OFICINAS JOIN REGIONES
ON (REGIONES.COD_REGION =OFICINAS.COD_REGION)
WHERE NOMBRE_RE='LEVANTE');

/*EJERCICIO 5*/
SELECT NOMBRE_RE 
FROM REGIONES 
WHERE COD_REGION NOT IN (SELECT COD_REGION FROM OFICINAS);

/*EJERCICIO 6*/
SELECT NOMBRE FROM REPVENTAS R WHERE NUM_VENTAS=
(SELECT MAX(NUM_VENTAS) FROM REPVENTAS WHERE OFICINA_REP=R.OFICINA_REP);

/*EJERCICIO 7*/
SELECT NOMBRE FROM REPVENTAS WHERE DIRECTOR =
(SELECT DIRECTOR FROM REPVENTAS WHERE NUMERO_REP=101);

/*EJERCICIO 8*/
SELECT NOMBRE, OFICINA, CIUDAD, NOMBRE_RE
FROM REPVENTAS R, OFICINAS O, REGIONES RE
WHERE R.OFICINA_REP= O.OFICINA AND 
RE.COD_REGION=O.COD_REGION AND
IMP_VENTAS=(SELECT MIN(IMP_VENTAS)
FROM REPVENTAS);

SELECT NOMBRE, OFICINA, CIUDAD, NOMBRE_RE
FROM REPVENTAS R JOIN OFICINAS O ON (R.OFICINA_REP=O.OFICINA)
JOIN REGIONES RE ON (RE.COD_REGION=O.COD_REGION)
WHERE IMP_VENTAS=(SELECT MIN(IMP_VENTAS)
FROM REPVENTAS);

/*EJERCICIO 9*/
SELECT NOMBRE, OFICINA, CIUDAD, NOMBRE_RE
FROM REPVENTAS R, OFICINAS O, REGIONES RE
WHERE R.OFICINA_REP= O.OFICINA AND 
RE.COD_REGION=O.COD_REGION AND
IMP_VENTAS=(SELECT MIN(IMP_VENTAS)
FROM REPVENTAS
WHERE OFICINA_REP=R.OFICINA_REP);

SELECT NOMBRE, OFICINA, CIUDAD, NOMBRE_RE
FROM REPVENTAS R JOIN OFICINAS O ON (R.OFICINA_REP=O.OFICINA)
JOIN REGIONES RE ON (RE.COD_REGION=O.COD_REGION)
WHERE IMP_VENTAS=(SELECT MIN(IMP_VENTAS)
FROM REPVENTAS
WHERE OFICINA_REP=R.OFICINA_REP);

/*EJERCICIO 10*/
SELECT NOMBRE, NOMBRE_RE
FROM REPVENTAS R JOIN OFICINAS O ON (O.DIRECTOR=R.DIRECTOR)
JOIN REGIONES RE ON (O.COD_REGION=RE.COD_REGION)
WHERE CIUDAD='Barcelona';

/*EJERCICIO 11*/
SELECT NOMBRE
FROM REPVENTAS 
WHERE NUMERO_REP IN (SELECT DIRECTOR FROM REPVENTAS)
OR NUMERO_REP IN (SELECT DIRECTOR
FROM OFICINAS);

/*EJERCICIO 12*/
SELECT R.NUMERO_REP, NOMBRE, CIUDAD, NOMBRE_RE
FROM REPVENTAS R JOIN OFICINAS O ON (R.OFICINA_REP = O.OFICINA) AND (R.NUMERO_REP = O.DIRECTOR)
JOIN REGIONES RE ON (O.COD_REGION=RE.COD_REGION);

/*EJERCICIO 13*/
SELECT OFICINAS.*, REGIONES.*
FROM OFICINAS JOIN REGIONES ON (OFICINAS.COD_REGION=REGIONES.COD_REGION) AND
TOTAL_VENTAS >= (SELECT AVG (TOTAL_VENTAS)
FROM OFICINAS);

/*EJERCICIO 14*/
SELECT REGIONES.COD_REGION, REGIONES.NOMBRE_RE
FROM OFICINAS JOIN REGIONES ON (REGIONES.COD_REGION=OFICINAS.COD_REGION)
WHERE REGIONES.COD_REGION NOT IN 
(SELECT COD_REGION
FROM OFICINAS
WHERE DIRECTOR IS NOT NULL);

/*EJERCICIO 15*/
SELECT OFICINA, CIUDAD 
FROM OFICINAS
WHERE OFICINA
NOT IN (SELECT DISTINCT NVL (OFICINA_REP,0)
FROM REPVENTAS);

/*EJERCICIO 16*/
SELECT NOMBRE, NUM_VENTAS, OFICINA_REP, CIUDAD, NOMBRE_RE
FROM REPVENTAS R JOIN OFICINAS O ON (O.OFICINA=R.OFICINA_REP)
JOIN REGIONES RE ON (O.COD_REGION=RE.COD_REGION)
WHERE NUM_VENTAS= (SELECT MAX(NUM_VENTAS) FROM REPVENTAS
WHERE OFICINA_REP=R.OFICINA_REP);

/*EJERCICIO 17*/
SELECT NOMBRE, OFICINA_REP, CIUDAD, NOMBRE_RE
FROM REPVENTAS R JOIN OFICINAS O ON (O.OFICINA=R.OFICINA_REP)
JOIN REGIONES RE ON (O.COD_REGION=RE.COD_REGION)
WHERE IMP_VENTAS BETWEEN (SELECT MIN(IMP_VENTAS)
FROM REPVENTAS)
AND (SELECT MIN (IMP_VENTAS)+1000
FROM REPVENTAS);

/*EJERCICIO 18*/
SELECT NOMBRE, OFICINA_REP, CIUDAD, NOMBRE_RE, IMP_VENTAS
FROM REPVENTAS R JOIN OFICINAS O ON (O.OFICINA=R.OFICINA_REP)
JOIN REGIONES RE ON (O.COD_REGION=RE.COD_REGION)
WHERE IMP_VENTAS=
(SELECT MAX(R2.IMP_VENTAS)
FROM REPVENTAS R2 JOIN OFICINAS O2 ON (O2.OFICINA=R2.OFICINA_REP)
JOIN REGIONES RE2 ON (O2.COD_REGION=RE2.COD_REGION)
WHERE O.COD_REGION=O2.COD_REGION);

/*EJERCICIO 19*/
SELECT NUMERO_REP,NOMBRE, OFICINA_REP, CIUDAD, NOMBRE_RE, IMP_VENTAS
FROM REPVENTAS R JOIN OFICINAS O ON (O.OFICINA=R.OFICINA_REP)
JOIN REGIONES RE ON (O.COD_REGION=RE.COD_REGION)
WHERE (NUMERO_REP IN (SELECT DIRECTOR
FROM REPVENTAS)
OR NUMERO_REP IN (SELECT DIRECTOR
FROM OFICINAS));

/*EJERCICIO 20*/
SELECT *
FROM REPVENTAS R
WHERE NUM_VENTAS BETWEEN
(SELECT MIN(NUM_VENTAS)
FROM REPVENTAS
WHERE OFICINA_REP=R.OFICINA_REP)
AND
(SELECT 10+MIN(NUM_VENTAS)
FROM REPVENTAS
WHERE OFICINA_REP=R.OFICINA_REP);